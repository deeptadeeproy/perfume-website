worker_processes 1;

events {
    worker_connections 1024;
}

http {
    # Required so OpenResty can resolve the "redis" hostname in Docker
    resolver 127.0.0.11 ipv6=off;

    lua_shared_dict cache 10m;

    init_by_lua_block {
        redis_host = "redis"
        redis_port = 6379
    }

    server {
        listen 80;
        server_name localhost;

        # Serve static files directly with browser caching
        location ~* \.(jpg|jpeg|png|gif|ico|avif|svg|webp|css|js|mp4|webm|woff2?)$ {
            root /usr/local/openresty/nginx/html;
            access_log off;
            expires 30d;
            add_header Cache-Control "public";
        }

        # Favicon and robots.txt
        location = /favicon.ico {
            root /usr/local/openresty/nginx/html;
            access_log off;
        }

        location = /robots.txt {
            root /usr/local/openresty/nginx/html;
            access_log off;
        }

        # Default handler â€“ cacheable dynamic content via Lua + Redis
        location / {
            content_by_lua_file /etc/nginx/cache.lua;
        }
    }
}
