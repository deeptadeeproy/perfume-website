worker_processes 1;

events {
    worker_connections 1024;
}

http {
    lua_shared_dict cache 10m;

    init_by_lua_block {
        redis_host = "redis"
        redis_port = 6379
    }

    server {
        listen 80;
        server_name localhost;

        # Serve static files directly (including AVIF)
        location ~* \.(jpg|jpeg|png|gif|ico|avif|svg|webp|css|js|mp4|webm|woff2?)$ {
            root /usr/local/openresty/nginx/html;
            access_log off;
            expires 30d;
            add_header Cache-Control "public";
        }

        # Handle favicon and robots.txt
        location = /favicon.ico {
            root /usr/local/openresty/nginx/html;
            access_log off;
        }

        location = /robots.txt {
            root /usr/local/openresty/nginx/html;
            access_log off;
        }

        # Redis + Lua caching for dynamic or HTML content
        location / {
            content_by_lua_file /etc/nginx/cache.lua;
        }
    }
}
